import { EnhancedPersona } from '@/core/data/personas/persona-library';

/**
 * Vulnerability Engine
 *
 * Models when and how personas show authentic vulnerability.
 * Real people don't always maintain perfect composure - they admit struggles,
 * show weakness, ask for help, and express uncertainty.
 *
 * Different personas have different vulnerability styles:
 * - Direct: "honestly, i struggle with this too"
 * - Humorous: "lol same, i'm a disaster at this"
 * - Deflecting: "asking for a friend who's definitely not me"
 *
 * Vulnerability makes conversations feel REAL.
 */

// TYPE DEFINITIONS

export interface VulnerabilityMoment {
    triggerComment: number; // Which comment index triggers vulnerability
    type: 'admission' | 'question' | 'personal_share' | 'self_deprecation';
    intensity: number; // 0-1 scale (how vulnerable)
    style: 'direct' | 'humorous' | 'deflecting';
    content: string; // Placeholder for generated content
    authentic: boolean; // Whether this feels natural for persona
}

export interface VulnerabilityTrigger {
    keyword: string; // What word/topic triggers vulnerability
    category: 'struggle' | 'failure' | 'uncertainty' | 'comparison' | 'burnout' | 'self_deprecation';
    likelihood: number; // 0-1 (how likely to trigger)
}

// VULNERABILITY MOMENT IDENTIFICATION

/**
 * Identify when persona should show vulnerability in thread
 *
 * @param comments - Array of comment contents
 * @param persona - Extended persona with vulnerability profile
 * @returns Array of vulnerability moments
 */
export function identifyVulnerabilityMoments(
    comments: string[],
    persona: EnhancedPersona
): VulnerabilityMoment[] {
    const moments: VulnerabilityMoment[] = [];

    const willingness = persona.emotionalProfile.vulnerability.willingnessToAdmit;

    // If persona has low willingness, might not be vulnerable at all
    if (Math.random() > willingness) {
        return moments; // No vulnerability this time
    }

    // Check each comment for vulnerability triggers
    comments.forEach((comment, index) => {
        const triggers = getVulnerabilityTriggers(persona);

        triggers.forEach(trigger => {
            // Check if comment contains trigger keyword
            if (comment.toLowerCase().includes(trigger.keyword.toLowerCase())) {
                // Random chance based on likelihood and willingness
                if (Math.random() < trigger.likelihood * willingness) {
                    moments.push({
                        triggerComment: index,
                        type: determineVulnerabilityType(trigger.category),
                        intensity: calculateVulnerabilityIntensity(persona, trigger),
                        style: persona.emotionalProfile.vulnerability.admissionStyle,
                        content: '', // Will be filled by generation
                        authentic: true
                    });
                }
            }
        });
    });

    // Limit to 1-2 vulnerability moments per thread (more feels forced)
    return moments.slice(0, 2);
}

// VULNERABILITY TRIGGERS

/**
 * Get vulnerability triggers for persona based on their struggles
 */
function getVulnerabilityTriggers(persona: EnhancedPersona): VulnerabilityTrigger[] {
    const triggers: VulnerabilityTrigger[] = [];

    // Add triggers from persona's triggers list
    persona.emotionalProfile.vulnerability.triggers.forEach(trigger => {
        triggers.push({
            keyword: trigger,
            category: categorizeTrigger(trigger),
            likelihood: 0.7 // High likelihood for explicit triggers
        });
    });

    // Add triggers from personal struggles
    persona.personalStruggles.current.forEach(struggle => {
        triggers.push({
            keyword: struggle,
            category: 'struggle',
            likelihood: 0.6
        });
    });

    persona.personalStruggles.recurring.forEach(struggle => {
        triggers.push({
            keyword: struggle,
            category: 'struggle',
            likelihood: 0.5
        });
    });

    // Add common vulnerability triggers
    const commonTriggers: VulnerabilityTrigger[] = [
        { keyword: 'imposter syndrome', category: 'uncertainty', likelihood: 0.8 },
        { keyword: 'burnout', category: 'burnout', likelihood: 0.8 },
        { keyword: 'struggling', category: 'struggle', likelihood: 0.6 },
        { keyword: 'failing', category: 'failure', likelihood: 0.7 },
        { keyword: 'bad at', category: 'self_deprecation', likelihood: 0.5 },
        { keyword: 'dont know', category: 'uncertainty', likelihood: 0.4 },
        { keyword: 'confused', category: 'uncertainty', likelihood: 0.5 },
        { keyword: 'overwhelming', category: 'struggle', likelihood: 0.6 },
        { keyword: 'everyone else', category: 'comparison', likelihood: 0.5 },
        { keyword: 'behind', category: 'comparison', likelihood: 0.5 }
    ];

    triggers.push(...commonTriggers);

    return triggers;
}

/**
 * Categorize trigger word
 */
function categorizeTrigger(trigger: string): VulnerabilityTrigger['category'] {
    const lowerTrigger = trigger.toLowerCase();

    if (lowerTrigger.includes('burnout') || lowerTrigger.includes('exhausted')) return 'burnout';
    if (lowerTrigger.includes('fail') || lowerTrigger.includes('mistake')) return 'failure';
    if (lowerTrigger.includes('dont know') || lowerTrigger.includes('uncertain')) return 'uncertainty';
    if (lowerTrigger.includes('everyone') || lowerTrigger.includes('others')) return 'comparison';
    if (lowerTrigger.includes('bad at') || lowerTrigger.includes('suck at') || lowerTrigger.includes('worst')) return 'self_deprecation';

    return 'struggle';
}

/**
 * Determine type of vulnerability based on category
 */
function determineVulnerabilityType(category: VulnerabilityTrigger['category']): VulnerabilityMoment['type'] {
    const typeMap: Record<VulnerabilityTrigger['category'], VulnerabilityMoment['type']> = {
        struggle: 'admission',
        failure: 'admission',
        uncertainty: 'question',
        comparison: 'personal_share',
        burnout: 'admission',
        self_deprecation: 'self_deprecation'
    };

    return typeMap[category] || 'admission';
}

/**
 * Calculate how intense this vulnerability should be
 */
function calculateVulnerabilityIntensity(
    persona: EnhancedPersona,
    trigger: VulnerabilityTrigger
): number {
    const baseIntensity = {
        struggle: 0.6,
        failure: 0.7,
        uncertainty: 0.5,
        comparison: 0.6,
        burnout: 0.8,
        self_deprecation: 0.5
    }[trigger.category];

    // Adjust for persona's willingness
    const adjusted = baseIntensity * persona.emotionalProfile.vulnerability.willingnessToAdmit;

    return Math.min(1, Math.max(0, adjusted));
}

// VULNERABILITY GENERATION

/**
 * Generate vulnerable admission based on style
 *
 * @param persona - Persona showing vulnerability
 * @param triggerContext - What triggered the vulnerability
 * @param style - How they express vulnerability
 * @param intensity - How vulnerable (0-1)
 * @returns Vulnerable statement
 */
export function generateVulnerableAdmission(
    persona: EnhancedPersona,
    triggerContext: string,
    style: 'direct' | 'humorous' | 'deflecting',
    intensity: number
): string {
    const templates = getVulnerabilityTemplates(style, intensity);
    const template = templates[Math.floor(Math.random() * templates.length)];

    // This would ideally call AI to generate full content
    // For now, return template
    return template;
}

/**
 * Get vulnerability templates by style and intensity
 */
function getVulnerabilityTemplates(
    style: 'direct' | 'humorous' | 'deflecting',
    intensity: number
): string[] {
    const templates: Record<string, Record<string, string[]>> = {
        direct: {
            high: [
                "honestly, i struggle with this a lot",
                "ngl this is something i'm really not great at",
                "yeah i've been there. it's tough and i still haven't figured it out",
                "i feel this so hard. been struggling with the same thing for months",
                "this hits close to home. i'm in the same boat"
            ],
            medium: [
                "honestly, i struggle with this too",
                "ngl i'm not great at this either",
                "yeah i deal with this sometimes",
                "i've had similar issues",
                "i get it, it's frustrating"
            ],
            low: [
                "i can relate to this",
                "been there",
                "yeah i've struggled with this before",
                "i understand the frustration"
            ]
        },

        humorous: {
            high: [
                "lol same, i'm an absolute disaster at this",
                "not me being called out rn",
                "why am i in this post and i don't like it",
                "too real, might delete later lol",
                "this is attacking me personally"
            ],
            medium: [
                "lol i'm not much better at this",
                "not me pretending i have this figured out",
                "same energy honestly",
                "calling me out lol"
            ],
            low: [
                "lol been there",
                "same honestly",
                "i feel this",
                "relatable"
            ]
        },

        deflecting: {
            high: [
                "i mean... not that i would know from personal experience or anything",
                "asking for a friend who's definitely not me and definitely struggling with this",
                "theoretically, if someone was really bad at this... just theoretically...",
                "purely hypothetical question about someone who might be me"
            ],
            medium: [
                "asking for a friend who's definitely not me",
                "hypothetically speaking",
                "not that this is me or anything",
                "i might know someone dealing with this"
            ],
            low: [
                "i've heard of people struggling with this",
                "apparently this is common",
                "friend mentioned dealing with this"
            ]
        }
    };

    const intensityLevel = intensity > 0.7 ? 'high' : intensity > 0.4 ? 'medium' : 'low';
    return templates[style][intensityLevel] || templates.direct.medium;
}

// VULNERABILITY INJECTION

/**
 * Inject vulnerability into OP reply
 *
 * @param baseReply - Original reply text
 * @param vulnerabilityMoment - Vulnerability to inject
 * @param persona - Persona showing vulnerability
 * @returns Reply with vulnerability naturally woven in
 */
export function injectVulnerabilityIntoReply(
    baseReply: string,
    vulnerabilityMoment: VulnerabilityMoment,
    persona: EnhancedPersona
): string {
    const admission = generateVulnerableAdmission(
        persona,
        baseReply,
        vulnerabilityMoment.style,
        vulnerabilityMoment.intensity
    );

    // Combine admission with base reply based on style
    if (vulnerabilityMoment.style === 'direct') {
        // Direct: Lead with admission
        return `${admission}. ${baseReply}`;
    } else if (vulnerabilityMoment.style === 'humorous') {
        // Humorous: Add as afterthought
        return `${baseReply} ${admission}`;
    } else {
        // Deflecting: Parenthetical
        return `${baseReply} (${admission})`;
    }
}

/**
 * Add vulnerability context to prompt
 *
 * Helps AI understand persona should be vulnerable here
 */
export function injectVulnerabilityContext(
    basePrompt: string,
    vulnerabilityMoment: VulnerabilityMoment,
    persona: EnhancedPersona
): string {
    const contextDescription = getVulnerabilityContextDescription(
        vulnerabilityMoment,
        persona
    );

    return `${basePrompt}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’­ VULNERABILITY MOMENT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${contextDescription}

This makes you more AUTHENTIC - real people admit struggles.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
}

/**
 * Get vulnerability context description
 */
function getVulnerabilityContextDescription(
    moment: VulnerabilityMoment,
    persona: EnhancedPersona
): string {
    const typeDescriptions: Record<VulnerabilityMoment['type'], string> = {
        admission: 'Admit that you struggle with this too. Be honest about your own challenges.',
        question: 'Ask a vulnerable question showing you don\'t have all the answers.',
        personal_share: 'Share a personal struggle or failure. Make it relatable.',
        self_deprecation: 'Be self-deprecating about your own skills/abilities in this area.'
    };

    const styleGuidance: Record<VulnerabilityMoment['style'], string> = {
        direct: 'Be DIRECT and honest: "honestly, i struggle with this too"',
        humorous: 'Use HUMOR to cope: "lol same, i\'m a disaster at this"',
        deflecting: 'DEFLECT with humor: "asking for a friend who\'s definitely not me"'
    };

    const intensityGuidance = moment.intensity > 0.7
        ? 'Be very vulnerable - really open up'
        : moment.intensity > 0.4
            ? 'Moderate vulnerability - admit struggle but not oversharing'
            : 'Light vulnerability - brief admission';

    return `Something in this comment triggered you to open up:
â€¢ What to express: ${typeDescriptions[moment.type]}
â€¢ How to express it: ${styleGuidance[moment.style]}
â€¢ How vulnerable: ${intensityGuidance}

This feels natural for you because this topic is one of your triggers.`;
}

// UTILITY FUNCTIONS

/**
 * Check if vulnerability is appropriate for subreddit
 */
export function isVulnerabilityAppropriate(
    subredditFormality: number,
    vulnerabilityIntensity: number
): boolean {
    // High formality subreddits (>0.7) - low vulnerability only
    if (subredditFormality > 0.7 && vulnerabilityIntensity > 0.5) {
        return false;
    }

    // Very casual subreddits (<0.3) - any vulnerability is fine
    if (subredditFormality < 0.3) {
        return true;
    }

    // Moderate subreddits - moderate vulnerability ok
    return vulnerabilityIntensity <= 0.7;
}

/**
 * Get vulnerability summary for debugging
 */
export function getVulnerabilitySummary(moments: VulnerabilityMoment[]): string {
    if (moments.length === 0) return 'No vulnerability moments';

    return moments.map((m, i) =>
        `Moment ${i + 1}: ${m.type} (${m.style}, intensity: ${(m.intensity * 100).toFixed(0)}%) at comment ${m.triggerComment}`
    ).join('\n');
}

/**
 * Adjust vulnerability for persona confidence
 *
 * Some personas are naturally more/less vulnerable regardless of situation
 */
export function adjustVulnerabilityForPersona(
    baseIntensity: number,
    persona: EnhancedPersona
): number {
    const willingness = persona.emotionalProfile.vulnerability.willingnessToAdmit;

    // Personas with low willingness (<0.4) rarely show high vulnerability
    if (willingness < 0.4 && baseIntensity > 0.6) {
        return baseIntensity * 0.6; // Reduce intensity
    }

    // Personas with high willingness (>0.7) might amplify vulnerability
    if (willingness > 0.7) {
        return Math.min(1, baseIntensity * 1.2);
    }

    return baseIntensity;
}
